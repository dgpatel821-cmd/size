<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Image Compressor</title>

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#667eea,#764ba2);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

.container {
    background: #fff;
    padding: 35px;
    border-radius: 20px;
    width: 420px;
    max-width: 95%;
    box-shadow: 0 20px 40px rgba(0,0,0,0.25);
    text-align: center;
}

h2 { margin-bottom: 25px; }

/* CLEAN UPLOAD CARD */
.upload-box {
    border: 2px dashed #764ba2;
    padding: 35px 20px;
    border-radius: 16px;
    cursor: pointer;
    margin-bottom: 25px;
    background: #faf9ff;
    transition: 0.3s;
}

.upload-box:hover {
    background: #f1ecff;
}

.upload-box strong {
    display:block;
    font-size:16px;
    margin-bottom:8px;
}

.upload-box span {
    font-size:13px;
    color:#666;
}

input[type="file"] { display:none; }

.input-group {
    text-align:left;
    margin-bottom:18px;
}

.input-group label {
    font-size:14px;
    display:block;
    margin-bottom:6px;
}

.input-group input, select {
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:14px;
}

button {
    width:100%;
    padding:14px;
    border:none;
    background:#764ba2;
    color:white;
    border-radius:12px;
    font-size:16px;
    cursor:pointer;
    margin-top:10px;
}

button:hover { background:#5a3780; }

.result-box {
    margin-top:20px;
    background:#f4f4f4;
    padding:14px;
    border-radius:12px;
    font-size:14px;
}

/* PROGRESS BAR */
.progress-container {
    width:100%;
    height:6px;
    background:#e0e0e0;
    border-radius:10px;
    margin-top:20px;
    overflow:hidden;
    display:none;
}

.progress-bar {
    height:100%;
    width:0%;
    background:#764ba2;
    transition: width 0.3s ease;
}

#downloadLink {
    display:none;
    margin-top:20px;
    width:100%;
    padding:14px;
    background:#28a745;
    color:white;
    border-radius:12px;
    text-decoration:none;
    font-weight:500;
}

#downloadLink:hover { background:#218838; }
</style>
</head>

<body>

<div class="container">

<h2>Smart Image Compressor</h2>

<label class="upload-box">
    <strong>Click to Upload Image</strong>
    <span>JPG, PNG, WebP Supported</span>
    <input type="file" id="upload" accept="image/*">
</label>

<div class="input-group">
    <label>Target Size (KB)</label>
    <input type="number" id="targetSize" value="25">
</div>

<div class="input-group">
    <label>Output Format</label>
    <select id="format">
        <option value="image/webp">WebP (Recommended)</option>
        <option value="image/jpeg">JPG</option>
    </select>
</div>

<button onclick="compressImage()">Compress Image</button>

<div id="sizeInfo" class="result-box" style="display:none;"></div>

<div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
</div>

<a id="downloadLink">Download Compressed Image</a>

</div>

<script>

async function compressImage() {

    const fileInput = document.getElementById("upload");
    const targetKB = parseInt(document.getElementById("targetSize").value);
    const format = document.getElementById("format").value;
    const sizeInfo = document.getElementById("sizeInfo");
    const downloadLink = document.getElementById("downloadLink");
    const progressBar = document.getElementById("progressBar");
    const progressContainer = document.getElementById("progressContainer");

    if (!fileInput.files[0]) {
        alert("Upload image first");
        return;
    }

    downloadLink.style.display = "none";
    sizeInfo.style.display = "none";
    progressContainer.style.display = "block";
    progressBar.style.width = "0%";

    const file = fileInput.files[0];
    const originalSize = (file.size/1024).toFixed(2);

    const img = new Image();
    img.src = URL.createObjectURL(file);

    img.onload = async function() {

        let width = img.width;
        let height = img.height;

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        async function compressWithBinarySearch(progressStep) {

            let minQ = 0.1;
            let maxQ = 1.0;
            let blob;

            for (let i=0; i<8; i++) {

                let midQ = (minQ + maxQ) / 2;

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img,0,0,width,height);

                blob = await new Promise(resolve =>
                    canvas.toBlob(resolve, format, midQ)
                );

                let sizeKB = blob.size / 1024;

                progressBar.style.width = (progressStep + i*5) + "%";

                if (sizeKB > targetKB)
                    maxQ = midQ;
                else
                    minQ = midQ;
            }

            return blob;
        }

        let finalBlob = await compressWithBinarySearch(20);

        while (finalBlob.size/1024 > targetKB && width > 300) {
            width *= 0.85;
            height *= 0.85;
            finalBlob = await compressWithBinarySearch(50);
        }

        progressBar.style.width = "100%";

        const finalSize = (finalBlob.size/1024).toFixed(2);

        sizeInfo.style.display="block";
        sizeInfo.innerHTML = `
            Original: <b>${originalSize} KB</b><br>
            Compressed: <b>${finalSize} KB</b>
        `;

        downloadLink.href = URL.createObjectURL(finalBlob);
        downloadLink.download = "compressed";
        downloadLink.style.display="block";
    };
}

</script>

</body>
</html>
