<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Image Compressor</title>

<style>
*{box-sizing:border-box;}

body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background:linear-gradient(135deg,#667eea,#764ba2);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
}

.container{
    background:#fff;
    padding:35px;
    border-radius:20px;
    width:420px;
    max-width:95%;
    box-shadow:0 20px 40px rgba(0,0,0,0.25);
    text-align:center;
}

h2{margin-bottom:25px;}

/* CLEAN UPLOAD CARD */
.upload-box{
    border:2px dashed #764ba2;
    padding:30px;
    border-radius:16px;
    margin-bottom:25px;
    background:#faf9ff;
    transition:0.3s;
    position:relative;
}

.upload-box.active{
    border:2px solid #764ba2;
    background:#f1ecff;
}

.upload-content{
    pointer-events:none;
}

.upload-placeholder{
    font-size:15px;
    color:#444;
}

.upload-preview{
    display:none;
}

.upload-preview img{
    width:100%;
    max-height:220px;
    object-fit:contain;
    border-radius:12px;
}

.file-name{
    margin-top:8px;
    font-size:13px;
    color:#555;
    word-break:break-word;
}

input[type="file"]{
    position:absolute;
    inset:0;
    opacity:0;
    cursor:pointer;
}

.input-group{
    text-align:left;
    margin-bottom:18px;
}

.input-group label{
    font-size:14px;
    display:block;
    margin-bottom:6px;
}

.input-group input,
select{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:14px;
}

button{
    width:100%;
    padding:14px;
    border:none;
    background:#764ba2;
    color:white;
    border-radius:12px;
    font-size:16px;
    cursor:pointer;
}

button:hover{background:#5a3780;}

.result-box{
    margin-top:20px;
    background:#f4f4f4;
    padding:14px;
    border-radius:12px;
    font-size:14px;
}

.progress-container{
    width:100%;
    height:6px;
    background:#e0e0e0;
    border-radius:10px;
    margin-top:20px;
    overflow:hidden;
    display:none;
}

.progress-bar{
    height:100%;
    width:0%;
    background:#764ba2;
    transition:width 0.2s ease;
}

#downloadLink{
    display:none;
    margin-top:20px;
    width:100%;
    padding:14px;
    background:#28a745;
    color:white;
    border-radius:12px;
    text-decoration:none;
}
</style>
</head>

<body>

<div class="container">

<h2>Smart Image Compressor</h2>

<div class="upload-box" id="uploadBox">
    <div class="upload-content">

        <div class="upload-placeholder" id="placeholder">
            <strong>Click to Upload or Drag Image Here</strong><br>
            JPG, PNG, WebP Supported
        </div>

        <div class="upload-preview" id="preview">
            <img id="previewImg">
            <div class="file-name" id="fileName"></div>
        </div>

    </div>
    <input type="file" id="upload" accept="image/*">
</div>

<div class="input-group">
    <label>Target Size (KB)</label>
    <input type="number" id="targetSize" value="25">
</div>

<div class="input-group">
    <label>Output Format</label>
    <select id="format">
        <option value="image/webp">WebP (Recommended)</option>
        <option value="image/jpeg">JPG</option>
    </select>
</div>

<button onclick="compressImage()">Compress Image</button>

<div id="sizeInfo" class="result-box" style="display:none;"></div>

<div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
</div>

<a id="downloadLink">Download Compressed Image</a>

</div>

<script>

const uploadBox=document.getElementById("uploadBox");
const fileInput=document.getElementById("upload");
const preview=document.getElementById("preview");
const previewImg=document.getElementById("previewImg");
const placeholder=document.getElementById("placeholder");
const fileName=document.getElementById("fileName");

/* PREVIEW */
fileInput.addEventListener("change",function(){
    if(this.files[0]){
        const reader=new FileReader();
        reader.onload=function(e){
            previewImg.src=e.target.result;
            fileName.textContent=fileInput.files[0].name;
            preview.style.display="block";
            placeholder.style.display="none";
        }
        reader.readAsDataURL(this.files[0]);
    }
});

/* DRAG ONLY INSIDE CARD (NO FULL PAGE BUG) */
uploadBox.addEventListener("dragover",e=>{
    e.preventDefault();
    uploadBox.classList.add("active");
});

uploadBox.addEventListener("dragleave",()=>{
    uploadBox.classList.remove("active");
});

uploadBox.addEventListener("drop",e=>{
    e.preventDefault();
    uploadBox.classList.remove("active");
    if(e.dataTransfer.files.length>0){
        fileInput.files=e.dataTransfer.files;
        fileInput.dispatchEvent(new Event("change"));
    }
});

/* SMART COMPRESSION SAME AS BEFORE */
async function compressImage(){

if(!fileInput.files[0]){
alert("Upload image first");
return;
}

const targetKB=parseInt(document.getElementById("targetSize").value);
const format=document.getElementById("format").value;
const sizeInfo=document.getElementById("sizeInfo");
const downloadLink=document.getElementById("downloadLink");
const progressBar=document.getElementById("progressBar");
const progressContainer=document.getElementById("progressContainer");

downloadLink.style.display="none";
sizeInfo.style.display="none";
progressContainer.style.display="block";
progressBar.style.width="0%";

const file=fileInput.files[0];
const originalSize=(file.size/1024).toFixed(2);

const img=new Image();
img.src=URL.createObjectURL(file);

img.onload=async function(){

let width=img.width;
let height=img.height;

const canvas=document.createElement("canvas");
const ctx=canvas.getContext("2d");

async function compressBinary(){
let minQ=0.1;
let maxQ=1.0;
let blob;

for(let i=0;i<8;i++){
let midQ=(minQ+maxQ)/2;

canvas.width=width;
canvas.height=height;
ctx.drawImage(img,0,0,width,height);

blob=await new Promise(resolve=>
canvas.toBlob(resolve,format,midQ)
);

let sizeKB=blob.size/1024;
progressBar.style.width=(20+i*5)+"%";

if(sizeKB>targetKB) maxQ=midQ;
else minQ=midQ;
}
return blob;
}

let finalBlob=await compressBinary();

while(finalBlob.size/1024>targetKB && width>300){
width*=0.85;
height*=0.85;
finalBlob=await compressBinary();
}

progressBar.style.width="100%";

const finalSize=(finalBlob.size/1024).toFixed(2);

sizeInfo.style.display="block";
sizeInfo.innerHTML=`Original: <b>${originalSize} KB</b><br>
Compressed: <b>${finalSize} KB</b>`;

downloadLink.href=URL.createObjectURL(finalBlob);
downloadLink.download="compressed";
downloadLink.style.display="block";
};
}

</script>

</body>
</html>
